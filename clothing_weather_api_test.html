<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simple Weather â†’ Outfit Demo</title>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#94a3b8; --accent:#22c55e; --accent2:#60a5fa;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:820px;margin:32px auto;padding:0 16px}
  h1{margin:0 0 16px 0; font-size:28px}
  .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;margin:12px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  button{background:var(--accent2);color:white;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  button.secondary{background:transparent;border:1px solid rgba(255,255,255,.2)}
  input{background:#0b1220;color:var(--text);border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:10px 12px;min-width:120px}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 12px}
  .hint{color:var(--muted);font-size:13px}
  .big{font-size:40px;font-weight:800}
  pre{white-space:pre-wrap;background:#0b1220;border:1px solid rgba(255,255,255,.15);padding:12px;border-radius:10px;max-height:240px;overflow:auto}
  .ok{color:#34d399}
  .warn{color:#f59e0b}
  .bad{color:#ef4444}
  .err{background:#2b0f10;border-color:#7f1d1d;color:#fecaca}
</style>
</head>
<body>
<div class="wrap">
  <h1>Simple Weather â†’ Outfit Demo</h1>
  <p class="hint">This minimal page proves: (1) geolocation, (2) API call to Openâ€‘Meteo, (3) outfit text recommendation based on <b>current temperature</b>, and (4) shows raw JSON returned so you can mirror the same request in Insomnia.</p>

  <div class="card">
    <h2>1) Choose Location</h2>
    <div class="row">
      <button id="btnLocate">Use My Location</button>
      <input id="lat" type="number" step="0.0001" placeholder="Latitude" value="38.9906"/>
      <input id="lon" type="number" step="0.0001" placeholder="Longitude" value="-76.9378"/>
      <button id="btnFetch">Fetch Weather</button>
    </div>
    <p class="hint">Tip: Geolocation only works on <b>https</b> or <b>localhost</b>. If blocked, just type lat/lon and press Fetch Weather.</p>
  </div>

  <div class="card" id="results" style="display:none">
    <h2>2) Weather Snapshot</h2>
    <div class="kv">
      <div>Place</div><div id="place">â€”</div>
      <div>Time</div><div id="time">â€”</div>
      <div>Temperature</div><div id="temp" class="big">â€”</div>
      <div>Humidity</div><div id="hum">â€”</div>
      <div>Wind</div><div id="wind">â€”</div>
    </div>
    <hr/>
    <h2>3) Outfit Recommendation</h2>
    <div id="advice" class="big">â€”</div>
    <p class="hint">Based on current hour temp only (simple rubric below).</p>
    <ul class="hint">
      <li>< 40Â°F: Heavy coat, scarf, boots</li>
      <li>40â€“54Â°F: Midâ€‘layer + light jacket</li>
      <li>55â€“69Â°F: Long sleeve or light sweater</li>
      <li>70â€“84Â°F: Tâ€‘shirt, breathable layers</li>
      <li>â‰¥ 85Â°F: Very light clothing, sun protection</li>
    </ul>
  </div>

  <div class="card" id="debug" style="display:none">
    <h2>4) Raw API Response (excerpt)</h2>
    <p class="hint">Paste this request into Insomnia to verify you can retrieve the same data.</p>
    <div id="curl" class="hint" style="margin-bottom:8px"></div>
    <pre id="json"></pre>
    <div id="err" class="card err" style="display:none"></div>
  </div>
</div>

<script>
// Utilities
const $ = s => document.querySelector(s);
const toF = c => Math.round(c * 9/5 + 32);
const toMPH = kph => Math.round(kph * 0.621371);

async function fetchForecast(lat, lon){
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/New_York';
  const url = new URL('https://api.open-meteo.com/v1/forecast');
  url.searchParams.set('latitude', lat);
  url.searchParams.set('longitude', lon);
  url.searchParams.set('hourly','temperature_2m,relative_humidity_2m,wind_speed_10m');
  url.searchParams.set('timezone', tz);
  try{
    const res = await fetch(url.toString(), {cache:'no-store', mode:'cors'});
    if(!res.ok){
      const text = await res.text().catch(()=> '');
      throw new Error(`Forecast HTTP ${res.status} ${res.statusText} ${text}`);
    }
    return await res.json();
  }catch(err){
    const eBox = document.getElementById('err');
    if(eBox){
      eBox.style.display='';
      eBox.textContent = `Forecast fetch failed. URL: ${url.toString()}
Reason: ${err}`;
      document.getElementById('debug').style.display='';
    }
    throw err;
  }
}

async function reverse(lat, lon){
  const url = new URL('https://geocoding-api.open-meteo.com/v1/reverse');
  url.searchParams.set('latitude', lat);
  url.searchParams.set('longitude', lon);
  url.searchParams.set('language', 'en');
  try{
    const r = await fetch(url.toString(), {cache:'no-store', mode:'cors'});
    if(!r.ok) throw new Error(`Reverse HTTP ${r.status}`);
    const j = await r.json();
    if(j.results && j.results[0]){
      const x=j.results[0];
      return `${x.name}, ${x.admin1 || x.admin2 || x.country}`;
    }
    return `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
  }catch(err){
    const eBox = document.getElementById('err');
    if(eBox){
      eBox.style.display='';
      eBox.textContent = `Reverse geocode failed (optional). URL: ${url.toString()}
Reason: ${err}`;
      document.getElementById('debug').style.display='';
    }
    return `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
  }
}

function outfitForTemp(f){
  if(f < 40) return 'ðŸ¥¶ Heavy coat, scarf, warm pants & boots';
  if(f < 55) return 'ðŸ§¥ Midâ€‘layer + light jacket';
  if(f < 70) return 'ðŸ‘• Long sleeve or light sweater';
  if(f < 85) return 'ðŸ©³ Tâ€‘shirt / breathable layers';
  return 'ðŸŒž Very light clothing + hat/SPF';
}

async function run(lat, lon){
  try{
    // fetch forecast FIRST (so if geocoding is blocked by an extension, the app still works)
    const data = await fetchForecast(lat,lon);
    // reverse geocode in background; do not block UI
    reverse(lat,lon).then(name=>{ document.getElementById('place').textContent = name; }).catch(()=>{});

    const h = data.hourly;
    const now = new Date();
    let idx = h.time.findIndex(t => new Date(t) >= now);
    if(idx === -1) idx = 0;

    const tempF = toF(h.temperature_2m[idx]);
    const hum = h.relative_humidity_2m[idx];
    const wind = toMPH(h.wind_speed_10m[idx]);

    document.getElementById('results').style.display = '';
    document.getElementById('time').textContent = new Date(h.time[idx]).toLocaleString();
    document.getElementById('temp').textContent = `${tempF}Â°F`;
    document.getElementById('hum').textContent = `${hum}%`;
    document.getElementById('wind').textContent = `${wind} mph`;
    document.getElementById('advice').textContent = outfitForTemp(tempF);

    // Show API request for Insomnia + partial JSON
    const curl = `GET https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relative_humidity_2m,wind_speed_10m&timezone=${encodeURIComponent(Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/New_York')}`;
    document.getElementById('curl').textContent = curl;
    document.getElementById('json').textContent = JSON.stringify({
      latitude: data.latitude,
      longitude: data.longitude,
      timezone: data.timezone,
      hourly: {
        time: h.time.slice(idx, idx+3),
        temperature_2m: h.temperature_2m.slice(idx, idx+3),
        relative_humidity_2m: h.relative_humidity_2m.slice(idx, idx+3),
        wind_speed_10m: h.wind_speed_10m.slice(idx, idx+3)
      }
    }, null, 2);
    document.getElementById('debug').style.display = '';
  } catch(e){
    alert('Error: ' + (e.message || e));
    console.error(e);
  }
}

// UI events
$('#btnFetch').addEventListener('click', ()=>{
  const lat = parseFloat($('#lat').value);
  const lon = parseFloat($('#lon').value);
  if(Number.isFinite(lat) && Number.isFinite(lon)) run(lat,lon);
  else alert('Please enter valid coordinates');
});

$('#btnLocate').addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert('Geolocation not supported in this browser'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude, longitude} = pos.coords;
    $('#lat').value = latitude.toFixed(4);
    $('#lon').value = longitude.toFixed(4);
    run(latitude, longitude);
  }, err => {
    alert('Location blocked/unavailable. Enter lat/lon manually.');
    console.warn(err);
  }, {enableHighAccuracy:true, timeout:10000, maximumAge:0});
});
</script>
</body>
</html>
