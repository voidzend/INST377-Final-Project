<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Climate Closet ‚Äì Outfit Planner</title>
  <style>
    :root{
      --bg:#0f172a;
      --panel:#111827;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --accent2:#60a5fa;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto,Inter,Arial;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    header{
      border-bottom:1px solid rgba(148,163,184,.25);
      background:#020617;
    }
    .nav{
      max-width:920px;
      margin:0 auto;
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .nav-title{
      font-weight:700;
      font-size:18px;
    }
    .nav-links{
      display:flex;
      gap:10px;
      font-size:14px;
    }
    .nav-links a{
      padding:6px 10px;
      border-radius:999px;
      color:var(--muted);
    }
    .nav-links a.active{
      background:rgba(96,165,250,.2);
      color:#e5f0ff;
    }
    .wrap{
      max-width:920px;
      margin:0 auto;
      padding:0 16px 48px;
    }
    h1{
      margin:24px 0 8px;
      font-size:28px;
    }
    h2{
      margin-top:0;
      font-size:20px;
    }
    .card{
      background:var(--panel);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:16px 18px;
      margin:14px 0;
    }
    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    button{
      background:var(--accent2);
      color:white;
      border:none;
      border-radius:10px;
      padding:10px 14px;
      font-weight:700;
      cursor:pointer;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    button.secondary{
      background:transparent;
      border:1px solid rgba(255,255,255,.25);
      color:var(--text);
      font-weight:500;
    }
    button:disabled{
      opacity:0.6;
      cursor:default;
    }
    input, select{
      background:#0b1220;
      color:var(--text);
      border:1px solid rgba(255,255,255,.25);
      border-radius:10px;
      padding:10px 12px;
      min-width:120px;
      font-size:14px;
    }
    label{
      font-size:13px;
      color:var(--muted);
    }
    .kv{
      display:grid;
      grid-template-columns:minmax(120px,160px) 1fr;
      gap:6px 12px;
      font-size:14px;
    }
    .hint{
      color:var(--muted);
      font-size:13px;
    }
    .big{
      font-size:32px;
      font-weight:800;
    }
    .advice-main{
      font-size:22px;
      font-weight:700;
      margin-bottom:4px;
    }
    pre{
      white-space:pre-wrap;
      background:#020617;
      border:1px solid rgba(255,255,255,.15);
      padding:12px;
      border-radius:10px;
      max-height:260px;
      overflow:auto;
      font-size:12px;
    }
    .err{
      background:#2b0f10;
      border:1px solid #7f1d1d;
      color:#fecaca;
      border-radius:10px;
      padding:10px 12px;
      font-size:13px;
      white-space:pre-wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      font-size:12px;
      color:var(--muted);
      gap:4px;
    }
    .pill-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:var(--accent);
    }
    .tag{
      display:inline-flex;
      align-items:center;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(148,163,184,.15);
      color:var(--muted);
      font-size:11px;
      margin:2px 4px 0 0;
    }
    .subtle-divider{
      height:1px;
      border:none;
      background:rgba(148,163,184,.3);
      margin:14px 0;
    }
    .outfit-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:6px;
    }
    .outfit-card{
      border-radius:10px;
      border:1px solid rgba(148,163,184,.4);
      padding:8px 10px;
      font-size:13px;
      background:rgba(15,23,42,.7);
    }
    .outfit-card-main{
      font-weight:600;
      margin-bottom:2px;
    }
    .danger-text{
      color:var(--danger);
      font-size:13px;
    }
    @media (max-width:600px){
      .kv{
        grid-template-columns:1fr;
      }
      .big{
        font-size:26px;
      }
    }
  </style>
</head>
<body>
<header>
  <div class="nav">
    <div class="nav-title">Climate Closet</div>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="planner.html" class="active">Outfit planner</a>
      <a href="about.html">About</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <h1>Weather ‚Üí Outfit Planner</h1>
  <p class="hint">
    Use your location (or manual coordinates) to fetch current weather from Open-Meteo.
    The planner turns that into a simple outfit recommendation and exposes the exact API
    request you can reuse in Insomnia.
  </p>

  <!-- 1. Location + context -->
  <div class="card">
    <h2>1) Choose Location &amp; Context</h2>
    <div class="row" style="margin-bottom:8px;">
      <button id="btnLocate">üìç Use My Location</button>
      <input id="lat" type="number" step="0.0001" placeholder="Latitude" value="38.9906" />
      <input id="lon" type="number" step="0.0001" placeholder="Longitude" value="-76.9378" />
      <button id="btnFetch">Fetch Weather</button>
    </div>
    <div class="row" style="gap:16px; margin-top:4px;">
      <div>
        <label for="contextSelect">Outfit context</label><br/>
        <select id="contextSelect">
          <option value="casual">Casual / daily</option>
          <option value="school">School / campus</option>
          <option value="work">Work / office</option>
          <option value="date">Date / going out</option>
          <option value="gym">Gym / active</option>
        </select>
      </div>
      <div>
        <span class="hint">
          Tip: Geolocation only works on <b>https</b> or <b>localhost</b>.
          If it fails, type lat/lon manually and press <b>Fetch Weather</b>.
        </span>
      </div>
    </div>
  </div>

  <!-- 2. Weather snapshot + basic outfit -->
  <div class="card" id="results" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:flex-start;">
      <h2>2) Weather Snapshot</h2>
      <span class="pill" id="statusPill" style="display:none;">
        <span class="pill-dot"></span>
        <span id="statusText">Ready</span>
      </span>
    </div>
    <div class="kv">
      <div>Place</div><div id="place">‚Äî</div>
      <div>Time</div><div id="time">‚Äî</div>
      <div>Temperature</div><div id="temp" class="big">‚Äî</div>
      <div>Humidity</div><div id="hum">‚Äî</div>
      <div>Wind</div><div id="wind">‚Äî</div>
    </div>
    <hr class="subtle-divider" />
    <h2>3) Outfit Recommendation</h2>
    <div class="advice-main" id="advice">‚Äî</div>
    <p class="hint" id="adviceDetail">
      Based on current hour temperature only (simple rubric below).
    </p>
    <ul class="hint" style="margin-top:6px;">
      <li>&lt; 40¬∞F: Heavy coat, scarf, boots</li>
      <li>40‚Äì54¬∞F: Mid-layer + light jacket</li>
      <li>55‚Äì69¬∞F: Long sleeve or light sweater</li>
      <li>70‚Äì84¬∞F: T-shirt, breathable layers</li>
      <li>‚â• 85¬∞F: Very light clothing, sun protection</li>
    </ul>

    <!-- Supabase outfit rules (future / optional, will call /api/outfits) -->
    <hr class="subtle-divider" />
    <h2>4) Rule-Based Suggestions (from DB)</h2>
    <p class="hint">
      This section is wired to call <code>/api/outfits</code> in the future.
      Until that endpoint exists, you‚Äôll see a friendly message instead of cards.
    </p>
    <div id="outfitList" class="outfit-list"></div>
    <p id="outfitError" class="danger-text" style="display:none;"></p>

    <div style="margin-top:10px;">
      <button id="btnSave" class="secondary">‚≠ê Save this outfit combo</button>
      <span id="saveStatus" class="hint" style="margin-left:8px;"></span>
    </div>
  </div>

  <!-- 5. Debug / Insomnia helper -->
  <div class="card" id="debug" style="display:none">
    <h2>5) Debug &amp; Insomnia Request</h2>
    <p class="hint">
      Use this URL in Insomnia or Postman to reproduce the weather request.
    </p>
    <pre id="curl"></pre>
    <pre id="json"></pre>
    <div id="err" class="err" style="display:none;"></div>
  </div>
</main>

<script>
  const $ = s => document.querySelector(s);

  const toF = c => Math.round(c * 9/5 + 32);
  const toMPH = kph => Math.round(kph * 0.621371);

  function outfitForTemp(f){
    if(f < 40) return 'ü•∂ Heavy coat, scarf, warm pants & boots';
    if(f < 55) return 'üß• Mid-layer + light jacket';
    if(f < 70) return 'üëï Long sleeve or light sweater';
    if(f < 85) return 'ü©≥ T-shirt / breathable layers';
    return 'üåû Very light clothing + hat / SPF';
  }

  function setStatus(text){
    const pill = $('#statusPill');
    const label = $('#statusText');
    if(!pill || !label) return;
    if(!text){
      pill.style.display = 'none';
      return;
    }
    pill.style.display = '';
    label.textContent = text;
  }

  // DIRECT Open-Meteo call (no backend required yet)
  async function fetchWeather(lat, lon){
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/New_York';
    const url = new URL('https://api.open-meteo.com/v1/forecast');
    url.searchParams.set('latitude', lat);
    url.searchParams.set('longitude', lon);
    url.searchParams.set('hourly','temperature_2m,relative_humidity_2m,wind_speed_10m');
    url.searchParams.set('timezone', tz);

    const res = await fetch(url.toString(), { cache:'no-store', mode:'cors' });
    if(!res.ok){
      const text = await res.text().catch(() => '');
      throw new Error(`Forecast HTTP ${res.status} ${res.statusText} ${text}`);
    }
    const raw = await res.json();

    // optional reverse geocode
    let place = `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
    try{
      const rUrl = new URL('https://geocoding-api.open-meteo.com/v1/reverse');
      rUrl.searchParams.set('latitude', lat);
      rUrl.searchParams.set('longitude', lon);
      rUrl.searchParams.set('language', 'en');
      const rRes = await fetch(rUrl.toString(), { cache:'no-store', mode:'cors' });
      if(rRes.ok){
        const j = await rRes.json();
        if(j.results && j.results[0]){
          const x = j.results[0];
          place = `${x.name}, ${x.admin1 || x.admin2 || x.country}`;
        }
      }
    }catch(e){
      console.warn('Reverse geocode failed (optional):', e);
    }

    return {
      raw,
      place,
      forecastUrl: url.toString()
    };
  }

  // Future endpoints ‚Äì these will error (and be caught) until you add a backend
  async function fetchOutfitRules(tempF, context){
    const params = new URLSearchParams({ temp: tempF, context });
    const url = `/api/outfits?${params.toString()}`;
    const res = await fetch(url, { cache:'no-store' });
    if(!res.ok){
      const text = await res.text().catch(() => '');
      throw new Error(`Outfits API HTTP ${res.status} ${res.statusText} ${text}`);
    }
    return res.json();
  }

  async function saveCurrentOutfit(state){
    const url = '/api/saved-outfits';
    const res = await fetch(url, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body:JSON.stringify(state)
    });
    if(!res.ok){
      const text = await res.text().catch(() => '');
      throw new Error(`Save API HTTP ${res.status} ${res.statusText} ${text}`);
    }
    return res.json();
  }

  function renderOutfitRules(list){
    const container = $('#outfitList');
    const errEl = $('#outfitError');
    container.innerHTML = '';
    errEl.style.display = 'none';
    errEl.textContent = '';

    if(!Array.isArray(list) || list.length === 0){
      const msg = document.createElement('p');
      msg.className = 'hint';
      msg.textContent =
        'No DB rules matched this weather + context yet. You can add some rules in your Supabase table later.';
      container.appendChild(msg);
      return;
    }

    list.forEach((rule, idx) => {
      const card = document.createElement('div');
      card.className = 'outfit-card';

      const main = document.createElement('div');
      main.className = 'outfit-card-main';
      main.textContent = rule.description || `Rule #${idx+1}`;

      const meta = document.createElement('div');
      meta.className = 'hint';
      const parts = [];
      if(typeof rule.min_temp === 'number' && typeof rule.max_temp === 'number'){
        parts.push(`${rule.min_temp}‚Äì${rule.max_temp}¬∞F`);
      }
      if(rule.context){
        parts.push(`Context: ${rule.context}`);
      }
      if(parts.length){
        meta.textContent = parts.join(' ‚Ä¢ ');
      }

      const tagsWrap = document.createElement('div');
      if(rule.tags && Array.isArray(rule.tags)){
        rule.tags.forEach(t => {
          const tag = document.createElement('span');
          tag.className = 'tag';
          tag.textContent = t;
          tagsWrap.appendChild(tag);
        });
      }

      card.appendChild(main);
      if(meta.textContent) card.appendChild(meta);
      if(tagsWrap.childNodes.length) card.appendChild(tagsWrap);

      container.appendChild(card);
    });
  }

  async function run(lat, lon){
    const debugCard = $('#debug');
    const errBox = $('#err');
    const btnFetch = $('#btnFetch');
    const btnLocate = $('#btnLocate');
    const btnSave = $('#btnSave');

    try{
      setStatus('Loading weather‚Ä¶');
      btnFetch.disabled = true;
      btnLocate.disabled = true;
      if(btnSave) btnSave.disabled = true;

      errBox.style.display = 'none';
      errBox.textContent = '';
      debugCard.style.display = 'none';

      const data = await fetchWeather(lat, lon);
      const raw = data.raw || {};
      const h = raw.hourly || {};
      const times = h.time || [];
      const temps = h.temperature_2m || [];
      const hums = h.relative_humidity_2m || [];
      const winds = h.wind_speed_10m || [];

      if(!times.length || !temps.length){
        throw new Error('Weather response missing hourly data.');
      }

      const now = new Date();
      let idx = times.findIndex(t => new Date(t) >= now);
      if(idx === -1) idx = 0;

      const tempF = toF(temps[idx]);
      const hum = hums[idx];
      const wind = toMPH(winds[idx]);

      $('#results').style.display = '';
      $('#time').textContent = new Date(times[idx]).toLocaleString();
      $('#temp').textContent = `${tempF}¬∞F`;
      $('#hum').textContent = (typeof hum === 'number') ? `${hum}%` : '‚Äî';
      $('#wind').textContent = (typeof wind === 'number') ? `${wind} mph` : '‚Äî';

      const place = data.place || `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
      $('#place').textContent = place;

      const mainAdvice = outfitForTemp(tempF);
      $('#advice').textContent = mainAdvice;
      $('#adviceDetail').textContent =
        `Based on ~${tempF}¬∞F right now. Context: ${$('#contextSelect').value}.`;

      // Show the Open-Meteo URL + JSON excerpt for Insomnia
      const upstream = data.forecastUrl || '(forecast URL not available)';
      $('#curl').textContent = `GET ${upstream}`;
      $('#json').textContent = JSON.stringify({
        latitude: raw.latitude,
        longitude: raw.longitude,
        timezone: raw.timezone,
        sample_hourly: {
          time: times.slice(idx, idx+3),
          temperature_2m: temps.slice(idx, idx+3),
          relative_humidity_2m: hums.slice(idx, idx+3),
          wind_speed_10m: winds.slice(idx, idx+3)
        }
      }, null, 2);
      debugCard.style.display = '';

      // Optional DB rules ‚Äì will just show a friendly message until backend exists
      try{
        setStatus('Loading DB outfit rules‚Ä¶');
        const ctx = $('#contextSelect').value;
        const rules = await fetchOutfitRules(tempF, ctx);
        renderOutfitRules(rules);
      }catch(innerErr){
        console.warn('Outfit rules fetch failed (expected if /api/outfits is missing):', innerErr);
        const errEl = $('#outfitError');
        errEl.style.display = '';
        errEl.textContent =
          'Could not load DB outfit rules. This is expected until /api/outfits + Supabase are implemented.';
      }

      const saveState = {
        place,
        temp_f: tempF,
        context: $('#contextSelect').value,
        advice: mainAdvice,
        observed_at: new Date(times[idx]).toISOString()
      };
      btnSave.dataset.state = JSON.stringify(saveState);
      btnSave.disabled = false;
      setStatus('Ready');
    }catch(e){
      console.error(e);
      setStatus('Error');
      alert('Error fetching or processing weather. See debug box for details.');

      if(errBox){
        errBox.style.display = '';
        errBox.textContent = String(e);
        debugCard.style.display = '';
      }
    }finally{
      btnFetch.disabled = false;
      btnLocate.disabled = false;
    }
  }

  // Event wiring
  $('#btnFetch').addEventListener('click', () => {
    const lat = parseFloat($('#lat').value);
    const lon = parseFloat($('#lon').value);
    if(Number.isFinite(lat) && Number.isFinite(lon)) run(lat, lon);
    else alert('Please enter valid coordinates');
  });

  $('#btnLocate').addEventListener('click', () => {
    if(!navigator.geolocation){
      alert('Geolocation not supported in this browser');
      return;
    }
    setStatus('Requesting location‚Ä¶');
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      $('#lat').value = latitude.toFixed(4);
      $('#lon').value = longitude.toFixed(4);
      run(latitude, longitude);
    }, err => {
      setStatus('Location blocked');
      alert('Location blocked/unavailable. Enter lat/lon manually.');
      console.warn(err);
    }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
  });

  $('#btnSave').addEventListener('click', async () => {
    const btn = $('#btnSave');
    const status = $('#saveStatus');
    const stateStr = btn.dataset.state;
    if(!stateStr){
      status.textContent = 'No outfit to save yet. Fetch weather first.';
      return;
    }
    let state;
    try{
      state = JSON.parse(stateStr);
    }catch{
      status.textContent = 'Internal state error.';
      return;
    }

    btn.disabled = true;
    status.textContent = 'Saving‚Ä¶';
    try{
      await saveCurrentOutfit(state);
      status.textContent = 'Saved! (Requires /api/saved-outfits to be implemented)';
    }catch(e){
      console.error(e);
      status.textContent = 'Save failed (expected until backend is wired).';
    }finally{
      btn.disabled = false;
      setTimeout(() => { status.textContent = ''; }, 4000);
    }
  });
</script>
</body>
</html>
