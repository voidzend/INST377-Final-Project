<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Climate Closet ‚Äì Outfit Planner</title>

  <style>
    :root{
      --bg:#0f172a;
      --panel:#111827;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --accent2:#60a5fa;
      --danger:#ef4444;
    }

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Inter,Arial;
    }

    header{
      border-bottom:1px solid rgba(148,163,184,.25);
      background:#020617;
    }

    .nav{
      max-width:920px;
      margin:0 auto;
      padding:12px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .nav-title{font-weight:700;font-size:18px;}
    .nav-links{display:flex;gap:10px;}
    .nav-links a{
      padding:6px 10px;
      border-radius:999px;
      color:var(--muted);
      text-decoration:none;
    }
    .nav-links a.active{
      background:rgba(96,165,250,.2);
      color:#e5f0ff;
    }

    .wrap{
      max-width:920px;
      margin:0 auto;
      padding:0 16px 48px;
    }

    h1{margin-top:24px;font-size:28px;}
    h2{margin-top:0;font-size:20px;}

    .card{
      background:var(--panel);
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      padding:16px 18px;
      margin-top:16px;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .hint{color:var(--muted);font-size:13px;}
    .big{font-size:32px;font-weight:800;}

    button{
      background:var(--accent2);
      color:white;
      padding:10px 14px;
      border:none;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
    }

    input,select{
      background:#0b1220;
      border:1px solid rgba(255,255,255,.25);
      padding:10px;
      border-radius:10px;
      min-width:120px;
      color:var(--text);
    }

    .kv{
      display:grid;
      grid-template-columns:160px 1fr;
      gap:10px;
      margin-top:10px;
    }

    .outfit-list{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .outfit-card{
      background:rgba(255,255,255,.05);
      border-radius:10px;
      padding:10px;
      border:1px solid rgba(255,255,255,.1);
    }

    .danger-text{color:var(--danger);}

    /* ===== WEATHER SLIDER ===== */
    #weatherSliderContainer{
      width:100%;
      height:220px;
      max-height:220px;
      overflow:hidden;
      border-radius:14px;
      position:relative;
    }
    #weatherSlider{
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:14px;
      display:block;
    }
    #sliderCaption{
      position:absolute;
      bottom:10px;
      left:12px;
      background:rgba(0,0,0,.45);
      padding:6px 12px;
      border-radius:999px;
      font-size:13px;
      color:white;
    }
  </style>
</head>
<body>

<header>
  <div class="nav">
    <div class="nav-title">Climate Closet</div>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a class="active" href="planner.html">Outfit planner</a>
      <a href="about.html">About</a>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- WEATHER SLIDER -->
  <section class="card">
    <h2>Today's Weather Vibes</h2>

    <div id="weatherSliderContainer">
      <img id="weatherSlider" src="" alt="">
      <div id="sliderCaption"></div>
    </div>

    <p class="hint">Rotating weather images ‚Äì powered by simple-slider.</p>
  </section>

  <h1>Weather ‚Üí Outfit Planner</h1>

  <!-- 1. LOCATION + CONTEXT -->
  <div class="card">
    <h2>1) Choose Location & Context</h2>
    <div class="row">
      <button id="btnLocate">üìç Use My Location</button>
      <input id="lat" type="number" step="0.0001" value="38.9906" />
      <input id="lon" type="number" step="0.0001" value="-76.9378" />
      <button id="btnFetch">Fetch Weather</button>
    </div>

    <div class="row" style="margin-top:12px;">
      <div>
        <label>Outfit context</label><br>
        <select id="contextSelect">
          <option value="casual">Casual</option>
          <option value="school">School</option>
          <option value="work">Work</option>
          <option value="date">Date</option>
          <option value="gym">Gym</option>
        </select>
      </div>
    </div>
  </div>

  <!-- 2. WEATHER SNAPSHOT -->
  <div id="results" class="card" style="display:none;">
    <h2>2) Weather Snapshot</h2>

    <div class="kv">
      <div>Place</div><div id="place">‚Äî</div>
      <div>Time</div><div id="time">‚Äî</div>
      <div>Temperature</div><div id="temp" class="big">‚Äî</div>
      <div>Humidity</div><div id="hum">‚Äî</div>
      <div>Wind</div><div id="wind">‚Äî</div>
    </div>

    <canvas id="tempChart"></canvas>
    <p class="hint">Mini temperature trend chart (Chart.js)</p>

    <hr>

    <h2>3) Rule-Based Suggestions (from Supabase)</h2>
    <div id="outfitList" class="outfit-list"></div>
    <p id="outfitError" class="danger-text" style="display:none;"></p>

    <button id="btnSave">‚≠ê Save this outfit</button>
    <span id="saveStatus" class="hint"></span>
  </div>

      <h2>4) Backup Outfit Recommendation</h2>
    <div id="advice" class="big">‚Äî</div>
    <p id="adviceDetail" class="hint"></p>

  

  <!-- Debug -->
  <div id="debug" class="card" style="display:none;">
    <h2>Debug / Insomnia</h2>
    <pre id="curl"></pre>
    <pre id="json"></pre>
    <div id="err" class="err" style="display:none;"></div>
  </div>

</main>

<!-- JS LIBRARIES -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/simple-slider/0.1.0/simpleslider.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* =====================================================
   WEATHER SLIDER (AUTO-ROTATING)
===================================================== */
const sliderImages = [
  {
    url: "https://images.pexels.com/photos/281260/pexels-photo-281260.jpeg?auto=compress&cs=tinysrgb&w=1200",
    caption: "Sunny skies ‚Äì light layers"
  },
  {
    url: "https://images.pexels.com/photos/110874/pexels-photo-110874.jpeg?auto=compress&cs=tinysrgb&w=1200",
    caption: "Rainy weather ‚Äî waterproof layers"
  },
  {
    url: "https://images.pexels.com/photos/158163/clouds-cloudporn-weather-lookup-158163.jpeg?auto=compress&cs=tinysrgb&w=1200",
    caption: "Cloudy skies ‚Äî light jacket"
  },
  {
    url: "https://plus.unsplash.com/premium_photo-1663090593977-9923cc536f3b?fm=jpg&q=60&w=3000&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MXx8c25vd3xlbnwwfHwwfHx8MA%3D%3D",
    caption: "Snowy ‚Äî heavy coat & boots"
  }
];

let sliderIndex = 0;

function updateSlider(){
  const img = document.getElementById("weatherSlider");
  const cap = document.getElementById("sliderCaption");
  const s = sliderImages[sliderIndex];

  img.src = s.url;
  cap.textContent = s.caption;

  sliderIndex = (sliderIndex + 1) % sliderImages.length;
}
updateSlider();
setInterval(updateSlider, 2000);


/* =====================================================
   MAIN APP LOGIC
===================================================== */
const $ = s => document.querySelector(s);
const toF = c => Math.round(c * 9/5 + 32);
const toMPH = kph => Math.round(kph * 0.621371);

let tempChart = null;
let lastTempF = null;

function outfitForTemp(f){
  if(f < 40) return 'ü•∂ Heavy coat, scarf, warm pants & boots';
  if(f < 55) return 'üß• Mid-layer + light jacket';
  if(f < 70) return 'üëï Long sleeve or light sweater';
  if(f < 85) return 'ü©≥ T-shirt / breathable layers';
  return 'üåû Very light clothing + hat / SPF';
}

async function fetchWeather(lat, lon){
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const url = new URL("https://api.open-meteo.com/v1/forecast");
  url.searchParams.set("latitude", lat);
  url.searchParams.set("longitude", lon);
  url.searchParams.set("hourly","temperature_2m,relative_humidity_2m,wind_speed_10m");
  url.searchParams.set("timezone", tz);

  const res = await fetch(url.toString());
  if(!res.ok) throw new Error("Weather fetch failed");

  const raw = await res.json();
  return raw;
}

async function loadOutfitRules(tempF, context){
  const res = await fetch(`/api/outfits?temp=${tempF}&context=${context}`);
  if(!res.ok) throw new Error("Failed DB rules");

  return res.json();
}

function renderOutfitRules(list){
  const container = $("#outfitList");
  container.innerHTML = "";

  if(!list || list.length === 0){
    container.innerHTML = `<p class="hint">No rules matched your temperature + context.</p>`;
    return;
  }

  list.forEach(rule=>{
    const card = document.createElement("div");
    card.className = "outfit-card";
    card.innerHTML = `
      <div><b>${rule.description}</b></div>
      <div class="hint">${rule.min_temp}‚Äì${rule.max_temp}¬∞F ‚Ä¢ ${rule.context}</div>
    `;
    container.appendChild(card);
  });
}

function drawTempChart(tempsF){
  const ctx = document.getElementById("tempChart").getContext("2d");

  if(tempChart) tempChart.destroy();

  tempChart = new Chart(ctx, {
    type: "line",
    data:{
      labels:["Now","1h","2h","3h","4h","5h","6h","7h","8h","9h","10h","11h","12h"],
      datasets:[{
        label:"Temp ¬∞F",
        data:tempsF.slice(0,13),
        borderColor:"#60a5fa",
        backgroundColor:"rgba(96,165,250,.3)"
      }]
    },
    options:{
      responsive:true,
      scales:{y:{beginAtZero:false}}
    }
  });
}

async function run(lat, lon){
  try{
    const raw = await fetchWeather(lat, lon);
    const h = raw.hourly;

    const nowIndex = 0;
    const tempsF = h.temperature_2m.map(toF);
    lastTempF = tempsF[nowIndex];

    $("#results").style.display = "";
    $("#place").textContent = `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
    $("#time").textContent = new Date().toLocaleString();
    $("#temp").textContent = `${lastTempF}¬∞F`;
    $("#hum").textContent = `${h.relative_humidity_2m[nowIndex]}%`;
    $("#wind").textContent = `${toMPH(h.wind_speed_10m[nowIndex])} mph`;

    drawTempChart(tempsF);

    const ctx = $("#contextSelect").value;
    $("#advice").textContent = outfitForTemp(lastTempF);
    $("#adviceDetail").textContent = `Based on ${lastTempF}¬∞F`;

    const rules = await loadOutfitRules(lastTempF, ctx);
    renderOutfitRules(rules);

  }catch(err){
    alert("Error: " + err.message);
  }
}

/* =====================================================
   EVENTS
===================================================== */
$("#btnFetch").addEventListener("click",()=>{
  const lat = parseFloat($("#lat").value);
  const lon = parseFloat($("#lon").value);
  run(lat,lon);
});

$("#btnLocate").addEventListener("click",()=>{
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude} = pos.coords;
    $("#lat").value = latitude.toFixed(4);
    $("#lon").value = longitude.toFixed(4);
    run(latitude,longitude);
  });
});

$("#contextSelect").addEventListener("change",()=>{
  if(lastTempF){
    const ctx = $("#contextSelect").value;
    loadOutfitRules(lastTempF, ctx)
      .then(renderOutfitRules)
      .catch(()=>{});
  }
});

/* SAVE BUTTON */
$("#btnSave").addEventListener("click", async ()=>{
  const body = {
    temp_f:lastTempF,
    context:$("#contextSelect").value,
    advice:$("#advice").textContent,
    place:$("#place").textContent,
    observed_at:new Date().toISOString()
  };

  const res = await fetch("/api/saved-outfits",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body)
  });

  if(res.ok){
    $("#saveStatus").textContent = "Saved!";
  }else{
    $("#saveStatus").textContent = "Error saving.";
  }

  setTimeout(()=>$("#saveStatus").textContent="",3000);
});

</script>

</body>
</html>

