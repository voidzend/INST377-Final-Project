<!doctype html> 
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Climate Closet ‚Äì Outfit Planner</title>
  <style>
    :root{
      --bg:#0f172a;
      --panel:#111827;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --accent2:#60a5fa;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto,Inter,Arial;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    header{
      border-bottom:1px solid rgba(148,163,184,.25);
      background:#020617;
    }
    .nav{
      max-width:920px;
      margin:0 auto;
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .nav-title{
      font-weight:700;
      font-size:18px;
    }
    .nav-links{
      display:flex;
      gap:10px;
      font-size:14px;
    }
    .nav-links a{
      padding:6px 10px;
      border-radius:999px;
      color:var(--muted);
    }
    .nav-links a.active{
      background:rgba(96,165,250,.2);
      color:#e5f0ff;
    }
    .wrap{
      max-width:920px;
      margin:0 auto;
      padding:0 16px 48px;
    }
    h1{
      margin:24px 0 8px;
      font-size:28px;
    }
    h2{
      margin-top:0;
      font-size:20px;
    }
    .card{
      background:var(--panel);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:16px 18px;
      margin:14px 0;
    }
    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    button{
      background:var(--accent2);
      color:white;
      border:none;
      border-radius:10px;
      padding:10px 14px;
      font-weight:700;
      cursor:pointer;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    button.secondary{
      background:transparent;
      border:1px solid rgba(255,255,255,.25);
      color:var(--text);
      font-weight:500;
    }
    button:disabled{
      opacity:0.6;
      cursor:default;
    }
    input, select{
      background:#0b1220;
      color:var(--text);
      border:1px solid rgba(255,255,255,.25);
      border-radius:10px;
      padding:10px 12px;
      min-width:120px;
      font-size:14px;
    }
    label{
      font-size:13px;
      color:var(--muted);
    }
    .kv{
      display:grid;
      grid-template-columns:minmax(120px,160px) 1fr;
      gap:6px 12px;
      font-size:14px;
    }
    .hint{
      color:var(--muted);
      font-size:13px;
    }
    .big{
      font-size:32px;
      font-weight:800;
    }
    .advice-main{
      font-size:22px;
      font-weight:700;
      margin-bottom:4px;
    }
    pre{
      white-space:pre-wrap;
      background:#020617;
      border:1px solid rgba(255,255,255,.15);
      padding:12px;
      border-radius:10px;
      max-height:260px;
      overflow:auto;
      font-size:12px;
    }
    .err{
      background:#2b0f10;
      border:1px solid #7f1d1d;
      color:#fecaca;
      border-radius:10px;
      padding:10px 12px;
      font-size:13px;
      white-space:pre-wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      font-size:12px;
      color:var(--muted);
      gap:4px;
    }
    .pill-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:var(--accent);
    }
    .tag{
      display:inline-flex;
      align-items:center;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(148,163,184,.15);
      color:var(--muted);
      font-size:11px;
      margin:2px 4px 0 0;
    }
    .subtle-divider{
      height:1px;
      border:none;
      background:rgba(148,163,184,.3);
      margin:14px 0;
    }
    .outfit-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:6px;
    }
    .outfit-card{
      border-radius:10px;
      border:1px solid rgba(148,163,184,.4);
      padding:8px 10px;
      font-size:13px;
      background:rgba(15,23,42,.7);
    }
    .outfit-card-main{
      font-weight:600;
      margin-bottom:2px;
    }
    .danger-text{
      color:var(--danger);
      font-size:13px;
    }
    @media (max-width:600px){
      .kv{
        grid-template-columns:1fr;
      }
      .big{
        font-size:26px;
      }
    }
  </style>
</head>

<body>
<header>
  <div class="nav">
    <div class="nav-title">Climate Closet</div>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="planner.html" class="active">Outfit planner</a>
      <a href="about.html">About</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <h1>Weather ‚Üí Outfit Planner</h1>
  <p class="hint">Use your location or manual coordinates to fetch weather, then get outfit recommendations.</p>

  <!-- LOCATION -->
  <div class="card">
    <h2>1) Choose Location & Context</h2>
    <div class="row" style="margin-bottom:8px;">
      <button id="btnLocate">üìç Use My Location</button>
      <input id="lat" type="number" step="0.0001" placeholder="Latitude" value="38.9906" />
      <input id="lon" type="number" step="0.0001" placeholder="Longitude" value="-76.9378" />
      <button id="btnFetch">Fetch Weather</button>
    </div>

    <div class="row" style="gap:16px; margin-top:4px;">
      <div>
        <label for="contextSelect">Outfit context</label><br/>
        <select id="contextSelect">
          <option value="casual">Casual / daily</option>
          <option value="school">School / campus</option>
          <option value="work">Work / office</option>
          <option value="date">Date / going out</option>
          <option value="gym">Gym / active</option>
        </select>
      </div>
      <div>
        <span class="hint">Tip: Geolocation only works on https or localhost.</span>
      </div>
    </div>
  </div>

  <!-- WEATHER -->
  <div class="card" id="results" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:flex-start;">
      <h2>2) Weather Snapshot</h2>
      <span class="pill" id="statusPill" style="display:none;">
        <span class="pill-dot"></span>
        <span id="statusText">Ready</span>
      </span>
    </div>

    <div class="kv">
      <div>Place</div><div id="place">‚Äî</div>
      <div>Time</div><div id="time">‚Äî</div>
      <div>Temperature</div><div id="temp" class="big">‚Äî</div>
      <div>Humidity</div><div id="hum">‚Äî</div>
      <div>Wind</div><div id="wind">‚Äî</div>
    </div>

    <hr class="subtle-divider" />

    <h2>3) Outfit Recommendation</h2>
    <div class="advice-main" id="advice">‚Äî</div>
    <p class="hint" id="adviceDetail">Based on current hour temperature only.</p>

    <ul class="hint" style="margin-top:6px;">
      <li>&lt; 40¬∞F: Heavy coat, scarf, boots</li>
      <li>40‚Äì54¬∞F: Mid-layer + light jacket</li>
      <li>55‚Äì69¬∞F: Long sleeve or light sweater</li>
      <li>70‚Äì84¬∞F: T-shirt, breathable layers</li>
      <li>‚â• 85¬∞F: Very light clothing, sun protection</li>
    </ul>

    <hr class="subtle-divider" />
    <h2>4) Rule-Based Suggestions (from DB)</h2>
    <div id="outfitList" class="outfit-list"></div>
    <p id="outfitError" class="danger-text" style="display:none;"></p>

    <div style="margin-top:10px;">
      <button id="btnSave" class="secondary">‚≠ê Save this outfit combo</button>
      <span id="saveStatus" class="hint" style="margin-left:8px;"></span>
    </div>
  </div>

  <!-- DEBUG -->
  <div class="card" id="debug" style="display:none">
    <h2>5) Debug & Insomnia Request</h2>
    <pre id="curl"></pre>
    <pre id="json"></pre>
    <div id="err" class="err" style="display:none;"></div>
  </div>
</main>

<script>
  const $ = s => document.querySelector(s);

  const toF = c => Math.round(c * 9/5 + 32);
  const toMPH = kph => Math.round(kph * 0.621371);

  function outfitForTemp(f){
    if(f < 40) return 'ü•∂ Heavy coat, scarf, warm pants & boots';
    if(f < 55) return 'üß• Mid-layer + light jacket';
    if(f < 70) return 'üëï Long sleeve or light sweater';
    if(f < 85) return 'ü©≥ T-shirt / breathable layers';
    return 'üåû Very light clothing + hat / SPF';
  }

  function setStatus(text){
    const pill = $('#statusPill');
    const label = $('#statusText');
    if(!pill || !label) return;
    if(!text){
      pill.style.display = 'none';
      return;
    }
    pill.style.display = '';
    label.textContent = text;
  }

  async function fetchWeather(lat, lon){
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/New_York';

    const url = new URL('https://api.open-meteo.com/v1/forecast');
    url.searchParams.set('latitude', lat);
    url.searchParams.set('longitude', lon);
    url.searchParams.set('hourly','temperature_2m,relative_humidity_2m,wind_speed_10m');
    url.searchParams.set('timezone', tz);

    const res = await fetch(url.toString(), { cache:'no-store', mode:'cors' });
    const raw = await res.json();

    let place = `${lat.toFixed(3)}, ${lon.toFixed(3)}`;

    try {
      const rUrl = new URL('https://geocoding-api.open-meteo.com/v1/reverse');
      rUrl.searchParams.set('latitude', lat);
      rUrl.searchParams.set('longitude', lon);
      const rRes = await fetch(rUrl.toString());
      if(rRes.ok){
        const j = await rRes.json();
        if(j.results && j.results[0]){
          const x = j.results[0];
          place = `${x.name}, ${x.admin1 || x.country}`;
        }
      }
    } catch(e){}

    return { raw, place, forecastUrl: url.toString() };
  }

  async function fetchOutfitRules(tempF, context){
    const params = new URLSearchParams({ temp: tempF, context });
    const res = await fetch(`/api/outfits?${params.toString()}`, { cache:'no-store' });
    if(!res.ok){
      throw new Error(`Outfits API ${res.status}`);
    }
    return res.json();
  }

  function renderOutfitRules(list){
    const container = $('#outfitList');
    const errEl = $('#outfitError');
    container.innerHTML = '';
    errEl.style.display = 'none';

    if(!list || list.length === 0){
      container.innerHTML = `<p class="hint">No DB rules matched this weather + context.</p>`;
      return;
    }

    list.forEach(rule => {
      const card = document.createElement('div');
      card.className = 'outfit-card';

      const main = document.createElement('div');
      main.className = 'outfit-card-main';
      main.textContent = rule.description;

      const meta = document.createElement('div');
      meta.className = 'hint';
      meta.textContent = `${rule.min_temp}‚Äì${rule.max_temp}¬∞F ‚Ä¢ ${rule.context}`;

      const tagsWrap = document.createElement('div');
      if(rule.tags){
        rule.tags.forEach(t=>{
          const tag=document.createElement('span');
          tag.className='tag';
          tag.textContent=t;
          tagsWrap.appendChild(tag);
        });
      }

      card.appendChild(main);
      card.appendChild(meta);
      if(tagsWrap.childNodes.length) card.appendChild(tagsWrap);
      container.appendChild(card);
    });
  }

  async function run(lat, lon){
    const debugCard = $('#debug');
    const errBox = $('#err');
    const btnFetch = $('#btnFetch');
    const btnLocate = $('#btnLocate');
    const btnSave = $('#btnSave');

    try{
      setStatus('Loading weather‚Ä¶');
      btnFetch.disabled = true;
      btnLocate.disabled = true;

      const data = await fetchWeather(lat, lon);
      const raw = data.raw;
      const h = raw.hourly;

      const times = h.time;
      const temps = h.temperature_2m;
      const hums = h.relative_humidity_2m;
      const winds = h.wind_speed_10m;

      let idx = times.findIndex(t => new Date(t) >= new Date());
      if(idx === -1) idx = 0;

      const tempF = toF(temps[idx]);
      const hum = hums[idx];
      const wind = toMPH(winds[idx]);

      $('#results').style.display = '';
      $('#time').textContent = new Date(times[idx]).toLocaleString();
      $('#temp').textContent = `${tempF}¬∞F`;
      $('#hum').textContent = hum + '%';
      $('#wind').textContent = wind + ' mph';
      $('#place').textContent = data.place;

      const ctx = $('#contextSelect').value;

      $('#advice').textContent = outfitForTemp(tempF);
      $('#adviceDetail').textContent = `Based on ~${tempF}¬∞F right now. Context: ${ctx}.`;

      $('#curl').textContent = `GET ${data.forecastUrl}`;
      $('#json').textContent = JSON.stringify(raw, null, 2);
      debugCard.style.display = '';

      // save last weather for auto-context switching
      window.__lastWeatherState = {
        tempF,
        place: data.place,
        observed_at: new Date(times[idx]).toISOString()
      };

      // load DB rules
      try {
        setStatus("Loading DB outfit rules‚Ä¶");
        const rules = await fetchOutfitRules(tempF, ctx);
        renderOutfitRules(rules);
      } catch(err) {
        $('#outfitError').style.display='';
        $('#outfitError').textContent='Could not load DB rules.';
      }

      // set save state
      btnSave.dataset.state = JSON.stringify({
        place: data.place,
        temp_f: tempF,
        context: ctx,
        advice: outfitForTemp(tempF),
        observed_at: new Date(times[idx]).toISOString()
      });

      btnSave.disabled = false;
      setStatus('Ready');

    } catch(e){
      console.error(e);
      setStatus('Error');
      $('#err').textContent = String(e);
      $('#err').style.display='';
      $('#debug').style.display='';
    } finally {
      btnFetch.disabled = false;
      btnLocate.disabled = false;
    }
  }

  // BUTTON EVENTS
  $('#btnFetch').addEventListener('click', () => {
    const lat = parseFloat($('#lat').value);
    const lon = parseFloat($('#lon').value);
    if(Number.isFinite(lat) && Number.isFinite(lon)) run(lat, lon);
    else alert('Invalid coordinates.');
  });

  $('#btnLocate').addEventListener('click', () => {
    if(!navigator.geolocation){
      alert("Geolocation not supported");
      return;
    }
    navigator.geolocation.getCurrentPosition(pos=>{
      const { latitude, longitude } = pos.coords;
      $('#lat').value = latitude.toFixed(4);
      $('#lon').value = longitude.toFixed(4);
      run(latitude, longitude);
    }, err=>{
      alert("Location blocked");
    });
  });

  $('#btnSave').addEventListener('click', async () => {
    const stateStr = $('#btnSave').dataset.state;
    if(!stateStr){
      $('#saveStatus').textContent='No outfit to save yet.';
      return;
    }
    $('#saveStatus').textContent='Saving‚Ä¶';
    setTimeout(()=>$('#saveStatus').textContent='',3000);
  });

  // auto update DB rules on context change
  $('#contextSelect').addEventListener('change', async () => {
    const st = window.__lastWeatherState;
    if(!st) return; // no weather fetched yet

    const tempF = st.tempF;
    const ctx = $('#contextSelect').value;

    setStatus("Updating rules‚Ä¶");

    try {
      const rules = await fetchOutfitRules(tempF, ctx);
      renderOutfitRules(rules);
      $('#adviceDetail').textContent =
        `Based on ~${tempF}¬∞F right now. Context: ${ctx}.`;
    } catch(err) {
      console.warn("Context update failed:", err);
      $('#outfitError').style.display='';
      $('#outfitError').textContent='Could not load DB rules for new context.';
    }

    setStatus("Ready");
  });
</script>
</body>
</html>
